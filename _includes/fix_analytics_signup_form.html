{% if include.language == "danish" %}
    {% assign lang_da = true %}
{% endif %}
<section class="fix-analytics-form">
    <form
        id="contact-form-analytics"
        method="post"
    >
        <label class="honeypot">
            <span>Repeat mail</span>
            <input
                type="text"
                name="UZZvvqxJKRlGGbvYaVxz"
                placeholder="mary.jane@broadwaytheater.com"
            />
            <!-- This is a honeypot, it is invisible to users, but not to bots. If it has value, it means it is a bot -->
        </label>
        <div class="contact-form">
            <h2>{% if lang_da %} Dine dom√¶ner {% else %} Your Domains {% endif %}</h2>
            <div data-domains-container>
                <label>
                    <span>{% if lang_da %} Dom√¶ne {% else %} Domain {% endif %}</span>
                    <input
                        placeholder="www.your-domain.com"
                        type="text"
                        name="domain_1"
                        required
                        data-domain-field
                    />
                </label>
            </div>
            <button
                class="btn"
                data-add-additional-domain
            >
                {% if lang_da %} Tilf√∏j flere dom√¶ner {% else %} Add additional domain {% endif %}
            </button>
            <span>
                {% if lang_da %}
                    Pris pr dom√¶ne: 37 dk.
                {% else %}
                    Price per domain: ‚Ç¨5.
                {% endif %}
            </span>
            <p>
                {% if lang_da %}
                    Total pris: <strong><span data-price-dkk>37</span> kr.</strong>
                {% else %}
                    Total price: <strong>‚Ç¨<span data-price-eur>5</span></strong>
                {% endif %}
            </p>
        </div>
        <div class="contact-form">
            <input hidden name="currency" value="{% if include.language == 'danish' %}DKK{% else %}EUR{% endif %}" />
            <input hidden name="locale" value="{% if include.language == 'danish' %}da_DK{% else %}en_US{% endif %}" />
            <h2>
                {% if lang_da %} Faktureringsinformation {% else %} Billing information{% endif %}
            </h2>
            <label>
                <span> {% if lang_da %} Kundetype {% else %} Customer Type {% endif %} </span>
                <select
                    name="type"
                    required
                >
                    <option value="company">
                        {% if lang_da %} Virksomhed {% else %} Company {% endif %}
                    </option>
                    <option value="person">
                        {% if lang_da %} Privatperson {% else %} Individual {% endif %}
                    </option>
                </select>
            </label>
            <label>
                <span> {% if lang_da %} Firmanavn {% else %} Company name {% endif %} </span>
                <input
                    type="text"
                    name="name"
                    placeholder="Company Inc"
                    required
                />
            </label>
            <label>
                <span>{% if lang_da %} Kontaktperson {% else %} Contact person {% endif %}</span>
                <input
                    type="text"
                    name="contactName"
                    required
                />
            </label>
            <label>
                <span>
                    {% if lang_da %}
                        Vejnavn og vejnummer
                    {% else %}
                        Street and street number
                    {% endif %}
                </span>
                <input
                    type="text"
                    name="street"
                    required
                />
            </label>
            <div class="two-col-inputs">
                <label>
                    <span> {% if lang_da %} By {% else %} City {% endif %} </span>
                    <input
                        type="text"
                        name="city"
                        required
                    />
                </label>
                <label for="">
                    <span> {% if lang_da %} Postnummer {% else %} Zip code {% endif %} </span>
                    <input
                        type="number"
                        name="zipcode"
                        required
                    />
                </label>
            </div>
            <div class="two-col-inputs">
                <label for="">
                    <span>
                        {% if lang_da %} Stat (valgfri) {% else %} State (optional) {% endif %}
                    </span>
                    <input
                        type="text"
                        name="state"
                    />
                </label>
                <label>
                    <span>
                        {% if lang_da %} Land {% else %} Country {% endif %} *
                    </span>
                    <select
                        name="countryId"
                        required
                    >
                        <option value="DK">Danmark</option>
                        <option value="NO">Norge</option>
                        <option value="SE">Sverige</option>
                    </select>
                </label>
            </div>
            <label>
                <span>
                    {% if lang_da %}
                        * Er dit land ikke p√• listen? <a href="mailto:get+analytics@deranged.dk">Skriv os en mail</a>, s√• finder vi ud af det.
                    {% else %}
                        * Are your country missing from the list? <a href="mailto:get+analytics@deranged.dk">Mail us</a> and we will fix it.
                    {% endif %}
                </span>
            </label>
            <label for="email">
                <span>Email</span>
                <input
                    type="email"
                    name="email"
                    placeholder="user@domain.com"
                    required
                />
            </label>
            <label>
                <span> {% if lang_da %} Telefonnummer {% else %} Phone number {% endif %} </span>
                <input
                    type="tel"
                    name="phone"
                    required
                />
            </label>
            <label>
                <span>
                    {% if lang_da %}
                        CVR
                    {% else %}
                        Company registration no.
                    {% endif %}
                </span>
                <input
                    type="text"
                    name="registrationNo"
                    required
                />
            </label>
            <label class="checkbox-container">
                <span>
                    {% if lang_da %}
                        M√• vi vise jeres navn og logo p√• vores hjemmeside for at vise at I bruger vores l√∏sning?
                    {% else %}
                        Can we use your name and logo on our website to show that you use our solution?
                    {% endif %}
                </span>
                <input
                    type="checkbox"
                    name="useLogoAndName"
                />
            </label>
            <label class="checkbox-container">
                <span>
                    {% if lang_da %}
                        M√• vi kontakte jer med henblik p√• at profilere jer som en privacy-bevidst virksomhed i branding relateret til Fix Analytics-produktet?
                    {% else %}
                        Can we contact you for the purpose of profiling you as a privacy-conscious company in branding related to the Fix Analytics product?
                    {% endif %}
                </span>
                <input
                    type="checkbox"
                    name="contactForProfiling"
                />
            </label>
            <label class="checkbox-container">
                <span>
                    {% if lang_da %}
                        Jeg accepterer <a target="_blank" href="/fix-google-analytics/vilkaar">vilk√•r og databehandleraftale</a>
                    {% else %}
                        I accept the <a target="_blank" href="/fix-google-analytics/vilkaar">terms and conditions</a>
                    {% endif %}
                </span>
                <input
                    required
                    type="checkbox"
                    name="accept_terms"
                />
            </label>
            <label>
                <span>
                    {% if lang_da %} Rabatkode (valgfri) {% else %} Discount Voucher (optional) {% endif %}
                </span>
                <input
                    type="text"
                    name="voucher"
                />
            </label>
            <button type="submit">{% if lang_da %} Tilmeld {% else %} Signup {% endif %}</button>
            <div
                class="contact-form-overlay contact-form-overlay-clickthrough"
                data-analytics-form-overlay
            >
                <div class="contact-form-overlay__message contact-form-overlay__message--awaiting">
                    {% if lang_da %}
                        Sender...
                    {% else %}
                        Sending request...
                    {% endif %}
                </div>
                <div class="contact-form-overlay__message contact-form-overlay__message--success">
                    <p>
                        {% if lang_da %}
                            Succes! üëç<br>
                            Du modtager en mail med information omkring implementation.
                        {% else %}
                            Success! üëç<br>
                            Please confirm you have recieved an email and your order has been registered.
                        {% endif %}
                    </p>
                </div>
                <div class="contact-form-overlay__message contact-form-overlay__message--error">
                    <p>
                        {% if lang_da %}
                            Noget gik desv√¶rre galt - Pr√∏v igen ‚ùå
                        {% else %}
                            Something went wrong - try again! ‚ùå
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </form>
</section>

<script>
    (function () {
        var form = document.getElementById("contact-form-analytics");
        var honeypot = form.UZZvvqxJKRlGGbvYaVxz;
        var contactFormOverlay = document.querySelector("[data-analytics-form-overlay]");
        var addAdditionalDomainButton = document.querySelector("[data-add-additional-domain");
        var domainsContainer = document.querySelector("[data-domains-container");

        addAdditionalDomainButton.addEventListener("click", function (e) {
            e.preventDefault();
            addNewDomainField(domainsContainer);
        });

        form.addEventListener("submit", function (e) {
            e.preventDefault();
            var honeypotValue = honeypot.value;
            if (honeypotValue !== "") {
                document.body.append("honeypot: '" + honeypotValue + "' (" + typeof honeypotValue + ")");
                return;
            }

            showOverlay();

            var customer = getFormFieldValues(
                form,
                [
                    "email",
                    "currency",
                    "locale",
                    "type",
                    "name",
                    "contactName",
                    "countryId",
                    "street",
                    "city",
                    "state",
                    "zipcode",
                    "phone",
                    "registrationNo",
                ]
            );
            var domainList = document.querySelectorAll("[data-domain-field]");
            var domains = [];
            var domainValues = domainList.forEach(function(input) {
                if (input.value) {
                    domains.push(input.value);
                }
            });
            sendRequestToApi("https://api.fix-analytics.deranged.dk/customer", {
                customer,
                domains,
                voucher: form.voucher.value,
                consent: {
                    "useLogoAndName": form.useLogoAndName.checked,
                    "contactForProfiling": form.contactForProfiling.checked,
                }
            });

            return false;
        });

        async function sendRequestToApi(url, data) {
            try {
                const rawResponse = await fetch(url, {
                    method: "POST",
                    headers: {
                        Accept: "application/json",
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                });
                const content = await rawResponse.json();

                console.log("success", content);
                showSuccess();
            } catch (error) {
                console.log("error", error);
                showFailure();
            }
        }

        function getFormFieldValues(form, fields) {
            var result = {};
            fields.forEach(function (field) {
                result[field] = form[field].value;
            });
            return result;
        }

        function updatePrice() {
            const domainList = document.querySelectorAll("[data-domain-field]");
            const dkkPriceElement = document.querySelector("[data-price-dkk]");
            const eurPriceElement = document.querySelector("[data-price-eur]");
            let totalPriceDkk = 0;
            let totalPriceEur = 0;
            domainList.forEach(function(input) {
                if (input.value) {
                    totalPriceDkk += 37;
                    totalPriceEur += 5;
                }
            });
            if (dkkPriceElement) {
                dkkPriceElement.innerHTML = totalPriceDkk;
            }
            if (eurPriceElement) {
                eurPriceElement.innerHTML = totalPriceEur;
            }
        }

        function addNewDomainField(containerElement) {
            var input = document.createElement("input");
            input.setAttribute("type", "text");
            input.setAttribute("placeholder", "www.your-domain.com");
            input.setAttribute("data-domain-field", true);
            containerElement
                .appendChild(document.createElement("label"))
                .appendChild(input);
            // Reassign Event when a new field is added
            document.querySelectorAll("[data-domain-field]").forEach(function(field) {
                field.addEventListener('input', updatePrice);
            });
        }

        function showOverlay() {
            contactFormOverlay.classList.add("contact-form-overlay--awaiting");
            contactFormOverlay.classList.remove("contact-form-overlay-clickthrough");
            requestAnimationFrame(function () {
                contactFormOverlay.classList.add("contact-form-overlay-visible");
            });
        }

        function showSuccess() {
            // TODO: Make the success state better/clearer
            contactFormOverlay.classList.remove("contact-form-overlay-visible");

            setTimeout(function () {
                contactFormOverlay.classList.remove("contact-form-overlay--awaiting");
                contactFormOverlay.classList.add("contact-form-overlay--success");
                contactFormOverlay.classList.add("contact-form-overlay-visible");

                setTimeout(function () {
                    contactFormOverlay.classList.remove("contact-form-overlay-visible");
                    contactFormOverlay.classList.remove("contact-form-overlay--success");

                    setTimeout(function () {
                        contactFormOverlay.classList.add("contact-form-overlay-clickthrough");
                    }, 500);
                }, 3000);
            }, 200);
        }

        function showFailure() {
            // TODO: Make the success state better/clearer
            contactFormOverlay.classList.remove("contact-form-overlay-visible");

            setTimeout(function () {
                contactFormOverlay.classList.remove("contact-form-overlay--awaiting");
                contactFormOverlay.classList.add("contact-form-overlay--error");
                contactFormOverlay.classList.add("contact-form-overlay-visible");

                setTimeout(function () {
                    contactFormOverlay.classList.remove("contact-form-overlay-visible");
                    contactFormOverlay.classList.remove("contact-form-overlay--error");

                    setTimeout(function () {
                        contactFormOverlay.classList.add("contact-form-overlay-clickthrough");
                    }, 500);
                }, 3000);
            }, 200);
        }
    })();
</script>
