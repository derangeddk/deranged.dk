<section>
    <form
        id="contact-form-analytics"
        action="http://api.fix-analytics.deranged.dk/customer"
        method="post"
    >
        <label class="honeypot">
            <span>Repeat mail</span>
            <input
                type="text"
                name="UZZvvqxJKRlGGbvYaVxz"
                placeholder="mary.jane@broadwaytheater.com"
            />
            <!-- This is a honeypot, it is invisible to users, but not to bots. If it has value, it means it is a bot -->
        </label>
        <div class="contact-form">
            <h2>{% if include.language == "danish" %} Dine domæner {% else %} Your Domains {% endif %}</h2>
            <div data-domains-container>
                <label>
                    <span>{% if include.language == "danish" %} Domæne {% else %} Domain {% endif %}</span>
                    <input
                        placeholder="www.your-domain.com"
                        type="text"
                        name="domain_1"
                        required
                        data-domain-field
                    />
                </label>
            </div>
            <button
                class="btn"
                data-add-additional-domain
            >
                {% if include.language == "danish" %} Tilføj flere domæner {% else %} Add additional domain {% endif %}
            </button>
        </div>
        <div class="contact-form">
            <h2>{% if include.language == "danish" %} Valgmuligheder {% else %} Options {% endif %}</h2>
            <label>
                <span> {% if include.language == "danish" %} Valuta {% else %} Currency {% endif %} </span>
                <select
                    name="currency"
                    required
                >
                    <option value="DKK">DKK</option>
                    <option value="EUR">Euro</option>
                </select>
            </label>
            <label>
                <span>
                    {% if include.language == "danish" %} Foretrukne sprog {% else %} Preferred Language {% endif %}
                </span>
                <select
                    name="locale"
                    required
                >
                    <option value="da_DK">Dansk</option>
                    <option value="en_US">English</option>
                </select>
            </label>
            <label>
                <span> {% if include.language == "danish" %} Kundetype {% else %} Customer Type {% endif %} </span>
                <select
                    name="customer_type"
                    required
                >
                    <option value="company">Enterprise</option>
                    <option value="person">Private</option>
                </select>
            </label>
            <label>
                <span>Discount Voucher (optional)</span>
                <input
                    type="text"
                    name="voucher"
                />
            </label>
        </div>
        <div class="contact-form">
            <h2>
                {% if include.language == "danish" %} Faktureringsinformation {% else %} Billing information{% endif %}
            </h2>
            <label>
                <span> {% if include.language == "danish" %} Firmanavn {% else %} Company name {% endif %} </span>
                <input
                    type="text"
                    name="name"
                    placeholder="Company Inc"
                    required
                />
            </label>
            <label>
                <span>
                    {% if include.language == "danish" %}
                        Vejnavn og vejnummer
                    {% else %}
                        Street and street number
                    {% endif %}
                </span>
                <input
                    type="text"
                    name="location_street"
                    required
                />
            </label>
            <div class="two-col-inputs">
                <label>
                    <span> {% if include.language == "danish" %} By {% else %} City {% endif %} </span>
                    <input
                        type="text"
                        name="location_city"
                        required
                    />
                </label>
                <label for="">
                    <span> {% if include.language == "danish" %} Postnummer {% else %} Zip code {% endif %} </span>
                    <input
                        type="number"
                        name="location_zipcode"
                        required
                    />
                </label>
            </div>
            <div class="two-col-inputs">
                <label for="">
                    <span>
                        {% if include.language == "danish" %} Stat (valgfri) {% else %} State (optional) {% endif %}
                    </span>
                    <input
                        type="text"
                        name="location_state"
                    />
                </label>
                <label>
                    <span> {% if include.language == "danish" %} Land {% else %} Country {% endif %} </span>
                    <select
                        name="location_country_id"
                        required
                    >
                        <option value="DK">Denmark</option>
                    </select>
                </label>
            </div>
            <label for="email">
                <span>Email</span>
                <input
                    type="text"
                    name="email"
                    placeholder="user@domain.com"
                    required
                />
            </label>
            <label>
                <span> {% if include.language == "danish" %} Telefonnummer {% else %} Phone number {% endif %} </span>
                <input
                    type="tel"
                    name="phone"
                    required
                />
            </label>
            <label>
                <span>
                    {% if include.language == "danish" %}
                        CVR
                    {% else %}
                        Registration No. (such as VAT or CVR)
                    {% endif %}
                </span>
                <input
                    type="text"
                    name="registration_number"
                    required
                />
            </label>
            <label>
                <span>
                    {% if include.language == "danish" %}
                        Jeg accepterer vilkår og databehandleraftale
                    {% else %}
                        I accept the terms and conditions
                    {% endif %}
                </span>
                <input
                    required
                    type="checkbox"
                    name="accept_terms"
                />
            </label>
            <button type="submit">{% if include.language == "danish" %} Tilmeld {% else %} Signup {% endif %}</button>
        </div>
    </form>
    <div
        class="contact-form-overlay contact-form-overlay-clickthrough"
        data-analytics-form-overlay
    >
        {% if include.language == "danish" %} Sender... {% else %} Sending... {% endif %}
    </div>
</section>

<script>
    (function () {
        var form = document.getElementById("contact-form-analytics");
        var honeypot = form.UZZvvqxJKRlGGbvYaVxz;
        var nameField = form.name;
        var emailField = form.email;
        var currencyField = form.currency;
        var localeField = form.locale;
        var customerTypeField = form.customer_type;
        var locationStreetField = form.location_street;
        var locationCityField = form.location_city;
        var locationZipField = form.location_zipcode;
        var locationStateField = form.location_state;
        var locationCountryIdField = form.location_country_id;
        var phoneField = form.phone;
        var registrationNumberField = form.registration_number;
        var voucherField = form.voucher;
        var acceptTermsField = form.accept_terms;
        var domainField = form.domain_1;

        var contactFormOverlay = document.querySelector("[data-analytics-form-overlay]");
        var addAdditionalDomainButton = document.querySelector("[data-add-additional-domain");
        var domainsContainer = document.querySelector("[data-domains-container");

        form.addEventListener("submit", function (e) {
            e.preventDefault();
            var honeypotValue = honeypot.value;
            if (honeypotValue !== "") {
                document.body.append("honeypot: '" + honeypotValue + "' (" + typeof honeypotValue + ")");
                return;
            }

            showOverlay();

            var customer = {
                email: emailField.value,
                currency: currencyField.value,
                locale: localeField.value,
                type: customerTypeField.value,
                name: nameField.value,
                countryId: locationCountryIdField.value,
                street: locationStreetField.value,
                cityText: locationCityField.value,
                stateText: locationStateField.value,
                zipcode: locationZipField.value,
                phone: phoneField.value,
                registrationNo: registrationNumberField.value,
            };
            var domainList = document.querySelectorAll("[data-domain-field]");
            var domains = [];
            var domainValues = domainList.forEach((input) => {
                if (input.value) {
                    domains.push(input.value);
                }
            });
            var voucher = voucherField.value;

            var data = {
                customer,
                domains,
                voucher,
            };

            sendRequestToApi(form.action, data);

            return false;
        });

        addAdditionalDomainButton.addEventListener("click", function (e) {
            e.preventDefault();
            addNewDomainField();
        });

        async function sendRequestToApi(url, data) {
            try {
                const rawResponse = await fetch(url, {
                    method: "POST",
                    headers: {
                        Accept: "application/json",
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                });
                const content = await rawResponse.json();

                console.log("DONE", content);
            } catch {
                console.log(error);
            }
        }

        function addNewDomainField() {
            var domainFields = document.querySelectorAll("[data-domain-field]");
            var domainFieldCount = domainFields.length + 1;
            var input = document.createElement("INPUT");
            input.setAttribute("Type", "text");
            input.setAttribute("Placeholder", "www.your-domain.com");
            input.setAttribute("data-domain-field", true);
            input.setAttribute("Name", "domain_" + domainFieldCount);
            domainsContainer.appendChild(document.createElement("label")).appendChild(input);
        }

        function showOverlay() {
            contactFormOverlay.innerText = "Getting in touch...";
            contactFormOverlay.classList.remove("contact-form-overlay-clickthrough");
            requestAnimationFrame(function () {
                contactFormOverlay.classList.add("contact-form-overlay-visible");
            });
        }

        function sendRequest(data, callbacks) {
            var req = new XMLHttpRequest();
            req.open("POST", form.action, true);
            req.setRequestHeader("Content-Type", "application/json");
            req.onreadystatechange = function () {
                if (req.readyState != 4) {
                    return;
                }
                if (req.status == 200) {
                    return callbacks.success();
                }
                console.error("Response from server on request", {
                    status: req.statusText,
                    responseType: req.responseType,
                    response: req.response,
                });
                callbacks.failure();
            };
            req.send(JSON.stringify(data));
        }

        function showSuccess() {
            contactFormOverlay.classList.remove("contact-form-overlay-visible");

            setTimeout(function () {
                contactFormOverlay.innerText = "Got in touch!";
                contactFormOverlay.classList.add("contact-form-overlay-visible");

                setTimeout(function () {
                    contactFormOverlay.classList.remove("contact-form-overlay-visible");

                    setTimeout(function () {
                        contactFormOverlay.classList.add("contact-form-overlay-clickthrough");
                    }, 500);
                }, 1500);
            }, 200);

            deleteTextInField(nameField);
            deleteTextInField(emailField);
            deleteTextInField(messageField);
            deleteTextInField(subjectField, function () {
                writeTextInField(subjectField, "Quote request");
            });
        }

        function showFailure() {
            contactFormOverlay.classList.remove("contact-form-overlay-visible");

            setTimeout(function () {
                contactFormOverlay.innerText = "Something went wrong - try again!";
                contactFormOverlay.classList.add("contact-form-overlay-visible");

                setTimeout(function () {
                    contactFormOverlay.classList.remove("contact-form-overlay-visible");

                    setTimeout(function () {
                        contactFormOverlay.classList.add("contact-form-overlay-clickthrough");
                    }, 500);
                }, 2000);
            }, 200);
        }

        function deleteTextInField(field, callback) {
            if (field.value.length == 0) {
                if (callback) {
                    return callback();
                }
                return;
            }
            field.value = field.value.substring(0, field.value.length - 1);
            setTimeout(deleteTextInField, 33, field, callback);
        }

        function writeTextInField(field, text) {
            if (text.length == 0) {
                return;
            }
            field.value += text[0];
            setTimeout(writeTextInField, 33, field, text.substring(1));
        }
    })();
</script>
