{% if include.language == "danish" %}
    {% assign lang_da = true %}
{% endif %}
<section class="fix-analytics-form">
    <form
        id="contact-form-analytics"
        method="post"
    >
        <label class="honeypot">
            <span>Repeat mail</span>
            <input
                type="text"
                name="UZZvvqxJKRlGGbvYaVxz"
                placeholder="mary.jane@broadwaytheater.com"
            />
            <!-- This is a honeypot, it is invisible to users, but not to bots. If it has value, it means it is a bot -->
        </label>
        <div class="contact-form card" data-form-step-1>
            <div class="card__body">
                <h2>{% if lang_da %} Tilmeld til Fix-Analytics {% else %} Signup to Fix-Analytics {% endif %}</h2>
                <p>
                    {% if lang_da %}Skriv adressen på din webside, f.eks. your-domain.dk.{% else %} The adress to your web site, fx. your-domain.com. {% endif %}
                </p>
                <div data-domains-container>
                    <label>
                        <span>{% if lang_da %} Domæne {% else %} Domain {% endif %}</span>
                        <input
                            placeholder="your-domain.com"
                            type="text"
                            name="domain_1"
                            value=""
                            required
                            data-domain-field
                        />
                    </label>
                </div>
                <div class="u-text-right text---right">
                    <button
                        class="button button--small button--dashed"
                        data-add-additional-domain
                    >
                        <strong>+</strong>{% if lang_da %} Tilføj flere domæner {% else %} Add additional domain {% endif %}
                    </button>
                </div>
                <span>
                    {% if lang_da %}
                        Pris pr domæne: 37 DKK.
                    {% else %}
                        Price per domain: € 5.
                    {% endif %}
                </span>
                <p>
                    {% if lang_da %}
                        Total pris: <strong><span data-price-dkk>0</span> kr.</strong>
                    {% else %}
                        Total price: <strong>€ <span data-price-eur>0</span></strong>
                    {% endif %}
                </p>
                <button
                    class="button u-mt-sm"
                    data-toggel-form-state
                    disabled
                >
                    {% if lang_da %} Gå til fakturering {% else %} Go to billing {% endif %}
                </button>
            </div>
        </div>
        <div class="contact-form card u-hide" data-form-step-2>
            <div class="card__body">
                <input hidden name="currency" value="{% if lang_da %}DKK{% else %}EUR{% endif %}" />
                <input hidden name="locale" value="{% if lang_da %}da_DK{% else %}en_US{% endif %}" />
                <div class="contact-form__navigation u-mb-md">
                    <a
                        class="contact-form__navigation-item"
                        href="#"
                        data-toggel-form-state
                    >
                        ⤌{% if lang_da %} Tilbage til domæner {% else %} Back to domains {% endif %}
                    </a>
                </div>
                <h2>
                    {% if lang_da %} Faktureringsinformation {% else %} Billing information{% endif %}
                </h2>
                <label>
                    <span> {% if lang_da %} Kundetype {% else %} Customer Type {% endif %} </span>
                    <select
                        name="type"
                        required
                        data-toggle-customer-type
                    >
                        <option value="company">
                            {% if lang_da %} Virksomhed {% else %} Company {% endif %}
                        </option>
                        <option value="person">
                            {% if lang_da %} Privatperson {% else %} Individual {% endif %}
                        </option>
                    </select>
                </label>
                <label>
                    <span data-company-name-label> {% if lang_da %} Firmanavn {% else %} Company name {% endif %} </span>
                    <span data-private-name-label hidden> {% if lang_da %} Navn {% else %} Name {% endif %} </span>
                    <input
                        type="text"
                        name="name"
                        required
                    />
                </label>
                <label>
                    <span>{% if lang_da %} Kontaktperson {% else %} Contact person {% endif %}</span>
                    <input
                        type="text"
                        name="contactName"
                        required
                        data-contact-name-field
                    />
                </label>
                <label>
                    <span>
                        {% if lang_da %}
                            Vejnavn og vejnummer
                        {% else %}
                            Street and street number
                        {% endif %}
                    </span>
                    <input
                        type="text"
                        name="street"
                        required
                    />
                </label>
                <div class="two-col-inputs">
                    <label>
                        <span> {% if lang_da %} By {% else %} City {% endif %} </span>
                        <input
                            type="text"
                            name="city"
                            required
                        />
                    </label>
                    <label for="">
                        <span> {% if lang_da %} Postnummer {% else %} Zip code {% endif %} </span>
                        <input
                            type="number"
                            name="zipcode"
                            required
                        />
                    </label>
                </div>
                <div class="two-col-inputs">
                    <label for="">
                        <span>
                            {% if lang_da %} Stat (valgfri) {% else %} State (optional) {% endif %}
                        </span>
                        <input
                            type="text"
                            name="state"
                        />
                    </label>
                    <label>
                        <span>
                            {% if lang_da %} Land {% else %} Country {% endif %} *
                        </span>
                        <select
                            name="countryId"
                            required
                        >
                            <option value="DK">Danmark</option>
                            <option value="NO">Norge</option>
                            <option value="SE">Sverige</option>
                        </select>
                    </label>
                </div>
                <label>
                    <span>
                        {% if lang_da %}
                            * Er dit land ikke på listen? <a href="mailto:get+analytics@deranged.dk">Skriv os en mail</a>, så finder vi ud af det.
                        {% else %}
                            * Is your country missing from the list? <a href="mailto:get+analytics@deranged.dk">Email us</a> and we will fix it.
                        {% endif %}
                    </span>
                </label>
                <label>
                    <span>Email</span>
                    <input
                        type="email"
                        name="email"
                        placeholder="user@domain.com"
                        required
                    />
                </label>
                <label>
                    <span> {% if lang_da %} Telefonnummer {% else %} Phone number {% endif %} </span>
                    <input
                        type="tel"
                        name="phone"
                        required
                    />
                </label>
                <label>
                    <span>
                        {% if lang_da %}
                            CVR
                        {% else %}
                            Company registration no.
                        {% endif %}
                    </span>
                    <input
                        type="text"
                        name="registrationNo"
                        required
                        data-registration-no-field
                    />
                </label>
                <label>
                    <span>
                        {% if lang_da %} Rabatkode (valgfri) {% else %} Discount Voucher (optional) {% endif %}
                    </span>
                    <input
                        type="text"
                        name="voucher"
                    />
                </label>
                <label class="checkbox-container">
                    <span>
                        {% if lang_da %}
                            Må vi vise jeres navn og logo på vores hjemmeside for at vise at I bruger vores løsning?
                        {% else %}
                            Can we use your name and logo on our website to show that you use our solution?
                        {% endif %}
                    </span>
                    <input
                        type="checkbox"
                        name="useLogoAndName"
                    />
                </label>
                <label class="checkbox-container">
                    <span>
                        {% if lang_da %}
                            Må vi kontakte jer med henblik på at profilere jer som en privacy-bevidst virksomhed i branding relateret til Fix Analytics-produktet?
                        {% else %}
                            Can we contact you for the purpose of profiling you as a privacy-conscious company in branding related to the Fix Analytics product?
                        {% endif %}
                    </span>
                    <input
                        type="checkbox"
                        name="contactForProfiling"
                    />
                </label>
                <label class="checkbox-container">
                    <span>
                        {% if lang_da %}
                            Jeg accepterer <a target="_blank" href="/fix-google-analytics/vilkaar">vilkår og databehandleraftale</a>
                        {% else %}
                            I accept the <a target="_blank" href="/fix-google-analytics/vilkaar">terms and conditions</a>
                        {% endif %}
                    </span>
                    <input
                        required
                        type="checkbox"
                        name="accept_terms"
                    />
                </label>
                <div
                    class="u-hide"
                    data-analytics-form-overlay
                >
                    <div class="contact-form-overlay__message contact-form-overlay__message--awaiting">
                        {% if lang_da %}
                            Sender...
                        {% else %}
                            Sending request...
                        {% endif %}
                    </div>
                    <div class="contact-form-overlay__message contact-form-overlay__message--success">
                        <h3>
                            {% if lang_da %}
                                Succes! 👍
                            {% else %}
                                Success! 👍
                            {% endif %}
                        </h3>
                        <p>
                            {% if lang_da %}
                                Du vil modtage en mail med en bekræftelse på din bestilling.
                            {% else %}
                                Please confirm you have recieved an email and your order has been registered.
                            {% endif %}
                        </p>
                    </div>
                    <div class="contact-form-overlay__message contact-form-overlay__message--success-with-redirect">
                        <p>
                            {% if lang_da %}
                                Du bliver videresendt til <span data-redirect-name></span> om <span data-redirect-countdown></span> sekunder.
                            {% else %}
                                You will be redirected to <span data-redirect-name></span> in <span data-redirect-countdown></span> seconds.
                            {% endif %}
                        </p>
                    </div>
                    <div class="contact-form-overlay__message contact-form-overlay__message--error">
                        <h3>
                            {% if lang_da %}
                                Noget gik desværre galt - Prøv igen ❌
                            {% else %}
                                Something went wrong - try again! ❌
                            {% endif %}
                        </h3>
                        <p data-detailed-error-message></p>
                    </div>
                </div>
                <button
                    class="button"
                    type="submit"
                    data-submit-form-button
                >
                    {% if lang_da %} Tilmeld {% else %} Signup {% endif %}
                </button>
            </div>
        </div>
    </form>
</section>

<script>
    (function () {
        var form = document.forms['contact-form-analytics'];
        var honeypot = form.UZZvvqxJKRlGGbvYaVxz;
        var contactFormOverlay = document.querySelector("[data-analytics-form-overlay]");
        var addAdditionalDomainButton = document.querySelector("[data-add-additional-domain");
        var domainsContainer = document.querySelector("[data-domains-container");
        var customerTypeSelect = document.querySelector("[data-toggle-customer-type]");
        const dkkPriceElement = document.querySelector("[data-price-dkk]");
        const eurPriceElement = document.querySelector("[data-price-eur]");
        const toggleFormStateButtons = document.querySelectorAll("[data-toggel-form-state]");
        const formStep1 = document.querySelector("[data-form-step-1]");
        const formStep2 = document.querySelector("[data-form-step-2]");
        const submitFormButton = document.querySelector("[data-submit-form-button]");
        const detailedErrorMessage = document.querySelector("[data-detailed-error-message]");
        const redirectCountdownElement = document.querySelector("[data-redirect-countdown]");
        const redirectNameElement = document.querySelector("[data-redirect-name]");

        const params = new Proxy(new URLSearchParams(window.location.search), { get: (searchParams, prop) => searchParams.get(prop) });
        const { redirectUrl, redirectName } = params;

        if (redirectUrl) {
            redirectNameElement.innerText = redirectName;
            redirectCountdownElement.innerText = 5;
        }

        customerTypeSelect.addEventListener("change", toggleCustomerType);
        toggleFormStateButtons.forEach(function(button) {
            button.addEventListener("click", toggleFormState);
        })

        addAdditionalDomainButton.addEventListener("click", function (e) {
            e.preventDefault();
            addNewDomainField(domainsContainer);
        });

        document.querySelector("[data-domain-field]").addEventListener('input', updatePrice);

        form.addEventListener("submit", function (e) {
            e.preventDefault();
            var honeypotValue = honeypot.value;
            if (honeypotValue !== "") {
                document.body.append("honeypot: '" + honeypotValue + "' (" + typeof honeypotValue + ")");
                return;
            }

            showOverlay();

            var customer = getFormFieldValues(
                form,
                [
                    "email",
                    "currency",
                    "locale",
                    "type",
                    "name",
                    "contactName",
                    "countryId",
                    "street",
                    "city",
                    "state",
                    "zipcode",
                    "phone",
                    "registrationNo",
                ]
            );
            var domainList = document.querySelectorAll("[data-domain-field]");
            var domains = [];
            var domainValues = domainList.forEach(function(input) {
                if (input.value) {
                    domains.push(input.value);
                }
            });
            sendRequestToApi("https://api.fix-analytics.deranged.dk/customer", {
                customer,
                domains,
                voucher: form.voucher.value,
                consent: {
                    "useLogoAndName": form.useLogoAndName.checked,
                    "contactForProfiling": form.contactForProfiling.checked
                }
            });

            return false;
        });

        async function sendRequestToApi(url, data) {
            const rawResponse = await fetch(url, {
                method: "POST",
                headers: {
                    Accept: "application/json",
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(data),
            });

            if (rawResponse.status === 200) {
                showSuccess();
            }
            else {
                showFailure();
                const content = await rawResponse.json();
                console.warn("content", content)
                detailedErrorMessage.innerHTML = content.reason ? content.reason.da_DK : content.messsage;
            }
        }

        function getFormFieldValues(form, fields) {
            var result = {};
            fields.forEach(function (field) {
                result[field] = form[field].value;
            });
            return result;
        }

        function updatePrice() {
            const domainList = document.querySelectorAll("[data-domain-field]");
            let totalPriceDkk = 0;
            let totalPriceEur = 0;
            domainList.forEach(function(input) {
                if (input.value) {
                    totalPriceDkk += 37;
                    totalPriceEur += 5;
                }
            });
            if (dkkPriceElement) {
                dkkPriceElement.innerHTML = totalPriceDkk;
            }
            if (eurPriceElement) {
                eurPriceElement.innerHTML = totalPriceEur;
            }
            if (!totalPriceDkk || !totalPriceEur ) {
                toggleFormStateButtons[0].setAttribute("disabled", true);
            }
            else {
                toggleFormStateButtons[0].removeAttribute("disabled");
            }
        }

        function toggleFormState(e) {
            e.preventDefault();
            formStep1.classList.toggle("u-hide");
            formStep2.classList.toggle("u-hide");
        }

        function toggleCustomerType(e) {
            const contactNameField = document.querySelector("[data-contact-name-field]");
            const registrationNoField = document.querySelector("[data-registration-no-field]");
            const companyNameLabel = document.querySelector("[data-company-name-label]");
            const privateNameLabel = document.querySelector("[data-private-name-label]");

            if (e.target.value === "person") {
                // disable stuff
                contactNameField.value = "";
                registrationNoField.value = "";
                contactNameField.setAttribute("disabled", true);
                registrationNoField.setAttribute("disabled", true);
                privateNameLabel.removeAttribute("hidden");
                companyNameLabel.setAttribute("hidden", true);

            }
            else {
                contactNameField.removeAttribute("disabled");
                registrationNoField.removeAttribute("disabled");
                companyNameLabel.removeAttribute("hidden");
                privateNameLabel.setAttribute("hidden", true);
            }
        }

        function addNewDomainField(containerElement) {
            var input = document.createElement("input");
            input.setAttribute("type", "text");
            input.setAttribute("placeholder", "your-domain.com");
            input.setAttribute("data-domain-field", true);
            input.setAttribute("value", "");
            containerElement
                .appendChild(document.createElement("label"))
                .appendChild(input);
            // Reassign Event when a new field is added
            document.querySelectorAll("[data-domain-field]").forEach(function(field) {
                field.addEventListener('input', updatePrice);
            });
        }

        function showOverlay() {
            contactFormOverlay.classList.remove("u-hide");
            contactFormOverlay.classList.add("contact-form-overlay--awaiting");
        }

        function showSuccess() {
            // TODO: Make the success state better/clearer
            submitFormButton.classList.add("u-hide");
            contactFormOverlay.classList.remove("contact-form-overlay--error");
            contactFormOverlay.classList.remove("contact-form-overlay--awaiting");
            contactFormOverlay.classList.add("contact-form-overlay--success");

            if (redirectUrl) {
                contactFormOverlay.classList.add("contact-form-overlay--success-with-redirect");
                setInterval(() => {
                    redirectCountdownElement.innerText -= 1;
                    if (redirectCountdownElement.innerText == 0) document.location.href = redirectUrl;
                }, 1 * 1000);
            }
        }

        function showFailure() {
            // TODO: Make the success state better/clearer
            contactFormOverlay.classList.remove("contact-form-overlay--awaiting");
            contactFormOverlay.classList.add("contact-form-overlay--error");
        }
    })();
</script>
